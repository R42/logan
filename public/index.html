<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>LogAn</title>
  <style>
textarea {
  width: 100%;
  height: 30em;
}

#example {
  margin-left: -20px;
}

.line {
  fill: none;
  stroke: #000;
  stroke-width: 1.5px;
}

.area {
  fill: #969696;
}

.attention {
  background: yellow;
  margin: -4px;
  padding: 4px;
}

#lcd_mosi .line { stroke: #ff8000; }
#lcd_mosi .area { fill  : #ffc080; }

#lcd_cs .line { stroke: #008000; }
#lcd_cs .area { fill  : #c0e0c0; }

#lcd_sck .line { stroke: #000080; }
#lcd_sck .area { fill  : #8080ff; }

#lcd_reset .line { stroke: #ff0000; }
#lcd_reset .area { fill  : #ff8080; }

#lcd_button .line { stroke: #808080; }
#lcd_button .area { fill  : #c0c0c0; }

textarea {
  width: 80%;
  height: 80px;
}

  </style>
</head>
<body>
  <p id="lcd_mosi"></p>
  <p id="lcd_cs"></p>
  <p id="lcd_sck"></p>
  <p id="lcd_reset"></p>
  <p id="lcd_button"></p>
  <form id="data" onsubmit="javascript:return false;">
    <textarea id="tsv" name="tsv">
      0	08400000
    108	08000000
    937	08400000
   1773	08000000
   2602	08400000
   3439	08000000
   4673	08400000
   5508	08000000
   6338	08400000
   7170	08000000
   8006	08400000
   8839	08000000
  11344	08400000
  12176	08000000
  13012	08400000
  13843	08800000
  14680	08c00000
  15512	08000000
  16347	08400000
  17180	08000000
  18017	08400000
  18849	08800000
  19683	08c00000
  20515	08000000
  21352	08400000
  22183	08800000
  23018	08c00000
  23850	08020000
    </textarea>
    <button onclick="update();return false;">Update</button>
  </form>
  <script src="http://d3js.org/d3.v2.min.js?2.8.1"></script>
  <script src="time-series-chart.js"></script>
  <script>

(function () {
  var init = false;
  var data = [[], [], [], [], []];
  var chart = new Array(5);

  var LCD_CS     = 17;
  var LCD_SCK    = 22;
  var LCD_MOSI   = 23;
  var LCD_BUTTON = 24;
  var LCD_RESET  = 27;

  function parseTime(str) {
    var ticks = parseInt(str, 10);
    return ticks;
  }

  function addSample(collection, time, pinout, bit) {
    collection.push([time, pinout & (1 << bit) ? 1 : 0]);
  }

  window.update = function () {
    var tsv = document.getElementById('tsv').value;
    data[0].length = 0;
    data[1].length = 0;
    data[2].length = 0;
    data[3].length = 0;
    data[4].length = 0;
    var previousPinout;
    tsv.split('\n').forEach(function (line, idx) {
      var columns = line.split('\t');
      if (columns.length !== 2) { return; }

      var currentTime  = parseTime(columns.shift());
      var currentPinout  = parseInt(columns.shift(), 16);
      if (idx === 0) {
        previousPinout = currentPinout;
        return
      }

      var previousTime = currentTime - 1;

      addSample(data[0], previousTime, previousPinout, LCD_MOSI  );
      addSample(data[1], previousTime, previousPinout, LCD_CS    );
      addSample(data[2], previousTime, previousPinout, LCD_SCK   );
      addSample(data[3], previousTime, previousPinout, LCD_RESET );
      addSample(data[4], previousTime, previousPinout, LCD_BUTTON);
      addSample(data[0], currentTime, currentPinout, LCD_MOSI  );
      addSample(data[1], currentTime, currentPinout, LCD_CS    );
      addSample(data[2], currentTime, currentPinout, LCD_SCK   );
      addSample(data[3], currentTime, currentPinout, LCD_RESET );
      addSample(data[4], currentTime, currentPinout, LCD_BUTTON);

      previousPinout = currentPinout;
    });

    var formatDate = d3.time.format("%b %Y");

    ['mosi', 'cs', 'sck', 'reset', 'button'].forEach(function(c, i) {
      d3.select('#lcd_' + c)
          .datum(data[i])
        .call(chart[i] = timeSeriesChart()
          .x(function(d) { return d[0]; })
          .y(function(d) { return d[1]; }));
    });
  };
})();

  </script>
</body>
</html>